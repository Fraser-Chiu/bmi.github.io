<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>商業模式分析自動化工具 (v6.0 - 最終版)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        
        .site-header {
            background-color: #000000;
            padding: 20px 0;
            text-align: center;
        }
        .site-header img {
            height: 40px; 
            max-width: 90%;
        }

        .container { max-width: 1200px; }
        .step-card { margin-bottom: 2rem; transition: opacity 0.3s; }
        .step-card.disabled { opacity: 0.5; pointer-events: none; }
        .step-card h2 { color: #0d6efd; display: flex; align-items: center; }
        .step-card h2 .badge { font-size: 1rem; margin-right: 10px; }
        .chart-container { position: relative; height: 35vh; width: 100%; margin-bottom: 1rem; }
        .company-group-header { font-size: 1.5rem; }
    </style>
</head>
<body>
    <header class="site-header">
        <!-- 【重要】請將 src 引號中的內容，替換為您自己的Logo Base64編碼 -->
        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA0MDAgMTAwIj48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkFyaWFsIEdyYW5kZSwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSI1MCIgZmlsbD0iI2ZmZmZmZiIgZm9udC13ZWlnaHQ9ImJvbGQiPufpei/mranilpEgTE9HTzwvdGV4dD48L3N2Zz4=" alt="公司Logo">
    </header>

    <div class="container py-5">
        <div class="text-center mb-5">
            <h1>商業模式分析自動化工具</h1>
            <p class="lead">請依循以下四個步驟，完成資料清理、分析與圖表產製。</p>
        </div>

        <!-- 步驟 1: 資料清理 -->
        <div class="card step-card" id="step1-card">
            <div class="card-body">
                <h2><span class="badge bg-primary">1</span>Data Cleansing (資料清理)</h2>
                <p>上傳原始資料 (csv 或 Excel)，系統將自動進行清洗、替換、移除欄位與處理重複資料。</p>
                <div class="mb-3">
                    <label for="fileUpload" class="form-label">選擇檔案</label>
                    <input class="form-control" type="file" id="fileUpload" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
                </div>
                <button class="btn btn-primary" id="startCleansingBtn">開始清理</button>
                <div class="mt-3" id="step1-output" style="display:none;">
                    <p class="text-success">✔ 資料清理完成！</p>
                    <a href="#" class="btn btn-success" id="downloadCleanedDataBtn">下載 cleaned_data.xlsx</a>
                </div>
                 <div class="spinner-border text-primary mt-3" role="status" id="step1-spinner" style="display:none;">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>

        <!-- 步驟 2: 整體圖表 -->
        <div class="card step-card disabled" id="step2-card">
            <div class="card-body">
                <h2><span class="badge bg-primary">2</span>Charting (整體)</h2>
                <p>視覺化呈現所有受測者的整體平均商業模式構面分數。</p>
                <button class="btn btn-primary" id="generateOverallChartBtn">產生整體圖表</button>
                <div class="mt-3" id="step2-output" style="display:none;">
                     <div class="spinner-border text-primary my-3" role="status" id="step2-spinner" style="display:none;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5 class="mt-3">商業模式構面平均分數</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <h6>長條圖</h6>
                            <div class="chart-container">
                                <canvas id="overallBarChart"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>雷達圖</h6>
                            <div class="chart-container">
                                <canvas id="overallRadarChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div id="overallTableContainer" class="mt-3"></div>
                </div>
            </div>
        </div>
        
        <!-- 步驟 3: 分析各公司 -->
        <div class="card step-card disabled" id="step3-card">
            <div class="card-body">
                <h2><span class="badge bg-primary">3</span>分析各公司 (Excel)</h2>
                <p>建立各公司或團隊的11構面分析總表與獨立分頁，並匯出為 Excel 檔案。</p>
                <div class="mb-3">
                    <label class="form-label fw-bold">此步驟將產生一份包含「總表」及「各公司分頁」的Excel報告。</label>
                </div>
                <button class="btn btn-primary" id="exportCompanyAnalysisBtn">匯出Excel分析檔</button>
                <div class="spinner-border text-primary mt-3" role="status" id="step3-spinner" style="display:none;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                 <div id="step3-output" class="mt-3" style="display:none;">
                    <p class="text-success">✔ 公司分析報告已成功產生！</p>
                </div>
            </div>
        </div>

        <!-- 步驟 4: 各公司獨立圖表 -->
        <div class="card step-card disabled" id="step4-card">
            <div class="card-body">
                <h2><span class="badge bg-primary">4</span>Charting (各公司)</h2>
                <p>為每一筆獨立的問卷回覆，在網頁上製作專屬圖表，並依公司名稱分組呈現。</p>
                <button class="btn btn-primary" id="generateIndividualChartsBtn">產生各公司圖表</button>
                <div class="spinner-border text-primary my-3" role="status" id="step4-spinner" style="display:none;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div id="step4-output" class="mt-3" style="display:none;">
                    <!-- Grouped charts will be appended here -->
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        const DIMENSION_MAPPING = { "價值主張": ["我們價值主張（產品、服務）的差異化是高的","我們價值主張（產品、服務）的被取代性是低的","顧客跳槽改用其他產品服務的轉換成本很高","我們的產品與服務之間有綜效"], "目標客層": ["我們有明確的顧客區隔","顧客的流失率很低","我們能有效獲取新顧客"], "通路": ["我們的通路可以有效的溝通我們的價值主張","我們的通路能有效接觸我們設定的目標客群","我們的通路能有效涵蓋目標客層","我們的通路可以突顯我們與其他競爭者的區隔","我們能有效整合不同類型的通路"], "顧客關係": ["我們有手段方法來經營不同客群的顧客關係","我們經營顧客關係的方式，能有效提升轉換率（例如：知道一評估一購買）","我們的顧客關係，可以幫助我們穩固既有客群（例如：提升忠誠度、黏性、回購率等）","我們的顧客關係，可以幫助我們開拓新客群與目標客群（例如：口碑、新客轉換率/ 提單率等）","我們的顧客關係可以創造品牌的價值"], "收益流": ["我們有多元的收益流：","相對於競爭對手，我們的毛利很高：","我們的收益可以預測、穩定、持續，不容易被外部因素影響","我們的銷售或訂單有延續性(例如：老客戶、重複購買、客戶彼此推薦）","我們不需要重新爭取每一筆銷售，或耗費額外資源才能爭取到訂單"], "關鍵活動": ["我們關鍵活動的執行效率很高（例如：生產、製造、研發、企劃...etc)","我們關鍵活動的執行品質很高","我們很少瞎忙（例如：作太多事和我們要創造的價值主張沒有關聯性）","我們的關鍵活動不容易被複製模仿"], "關鍵資源": ["我們掌握關鍵資源","我們的關鍵資源不容易被複製或取得","我們的關鍵資源不需大量投資就可擴大規模"], "關鍵合作夥伴": ["我們的關鍵合作夥伴不容易跳槽","我們不被關鍵合作夥伴綁架","失去了某些關鍵合作夥伴，我們的生意仍可以持續","我們在維繫關鍵伙伴關係所花費的時間成本與資源很少、極有效率"], "成本結構": ["我們的成本結構有競爭力（例如：較競爭對手低）","我們的成本不容易受到外部因素影響而有大幅波動"], "環境影響力": ["我們的「環境影響力」是具體且可量化的(例如：碳盤查、產品生命週期盤查、綠能%、節\n能%、減少廢棄物或邊角料、可再生材料使用比例、植樹覆蓋面積、生物多樣性…）","客戶會因為我們創造的「環境影響力」而以我們的產品服務為優先選\n擇","合作夥伴會因為我們創造的「環境影響力」而以我們為優先合作選擇","我們以「環境影響力」為核心競爭力，是可持續的，而非一次性的活動","我們以「環境影響力」為核心競爭力，且能有效降低對財務或營運的衝擊 (例如：因碳費或碳關稅的開徵而提高成本，合規成為供應商基本門檻...etc)"], "社會影響力": ["我們的「社會影響力」是具體且可量化的 (e.g. SROI)","客戶會因為我們創造的「社會影響力」而以我們的產品服務為優先選\n擇","我們以「創造社會影響力」為核心競爭力，是可持續的 ，而非一次性的行銷活動","我們以「創造社會影響力」為核心競爭力，且能有效管理對財務或營\n運的影響(例如：仍可有效進行成本結構管理、避免營運流程過度複雜\n化、維持健康收益流….etc)"]};
        const DIMENSIONS = Object.keys(DIMENSION_MAPPING);
        const PERSONAL_INFO_COLS = ['您的公司（或組織/團隊）名稱', '您的姓名', '留下E-mail，讓我們將結果寄給您'];
        const ALL_QUESTION_COLS_RAW = Object.values(DIMENSION_MAPPING).flat();
        const ALL_QUESTION_COLS = [...new Set(ALL_QUESTION_COLS_RAW)];
        const COLUMNS_TO_KEEP = [...ALL_QUESTION_COLS, ...PERSONAL_INFO_COLS];
        let cleanedData = null;
        
        const fileUpload = document.getElementById('fileUpload');
        const startCleansingBtn = document.getElementById('startCleansingBtn');
        const step1Output = document.getElementById('step1-output');
        const downloadCleanedDataBtn = document.getElementById('downloadCleanedDataBtn');
        const step1Spinner = document.getElementById('step1-spinner');
        const step2Card = document.getElementById('step2-card');
        const generateOverallChartBtn = document.getElementById('generateOverallChartBtn');
        const step2Output = document.getElementById('step2-output');
        const step2Spinner = document.getElementById('step2-spinner');
        const step3Card = document.getElementById('step3-card');
        const exportCompanyAnalysisBtn = document.getElementById('exportCompanyAnalysisBtn');
        const step3Output = document.getElementById('step3-output');
        const step3Spinner = document.getElementById('step3-spinner');
        const step4Card = document.getElementById('step4-card');
        const generateIndividualChartsBtn = document.getElementById('generateIndividualChartsBtn');
        const step4Output = document.getElementById('step4-output');
        const step4Spinner = document.getElementById('step4-spinner');

        startCleansingBtn.addEventListener('click', () => { if (fileUpload.files[0]) handleStep1(); else alert('請先選擇一個檔案！'); });
        generateOverallChartBtn.addEventListener('click', handleStep2);
        exportCompanyAnalysisBtn.addEventListener('click', handleStep3);
        generateIndividualChartsBtn.addEventListener('click', handleStep4);

        async function handleStep1() { startCleansingBtn.disabled = true; step1Spinner.style.display = 'block'; step1Output.style.display = 'none'; await new Promise(resolve => setTimeout(resolve, 500)); try { const file = fileUpload.files[0]; const data = await file.arrayBuffer(); const workbook = XLSX.read(data, { cellDates: true }); const sheetName = workbook.SheetNames[0]; let jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { raw: false }); const replacements = { "不適用-0": 0, "極須改進-1": 1, "有改善空間-3": 3, "繼續維持-5": 5 }; let processedData = jsonData.map(row => { const newRow = {}; for (const key in row) { const cleanKey = key.replace(/\r?\n|\r/g, ""); let value = row[key]; if (typeof value === 'string' && replacements.hasOwnProperty(value.trim())) { value = replacements[value.trim()]; } newRow[cleanKey] = value; } return newRow; }); const uniqueEntries = {}; processedData.forEach(row => { const compositeKey = PERSONAL_INFO_COLS.map(col => (row[col] || '').toString().trim()).join('||'); if (compositeKey === '||') { uniqueEntries[Math.random()] = row; } else { uniqueEntries[compositeKey] = row; } }); processedData = Object.values(uniqueEntries); if (processedData.length === 0) { throw new Error("清理後沒有剩下任何資料。請檢查檔案內容。"); } const finalData = processedData.map(row => { const newRow = {}; COLUMNS_TO_KEEP.forEach(col => { const cleanedColName = col.replace(/\r?\n|\r/g, ""); newRow[cleanedColName] = row[cleanedColName]; }); return newRow; }); cleanedData = finalData; const newSheet = XLSX.utils.json_to_sheet(cleanedData, { header: COLUMNS_TO_KEEP }); const newWorkbook = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(newWorkbook, newSheet, 'cleaned_data'); const excelBuffer = XLSX.write(newWorkbook, { bookType: 'xlsx', type: 'array' }); const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }); downloadCleanedDataBtn.href = URL.createObjectURL(blob); downloadCleanedDataBtn.download = 'cleaned_data.xlsx'; step1Spinner.style.display = 'none'; step1Output.style.display = 'block'; step2Card.classList.remove('disabled'); step3Card.classList.remove('disabled'); step4Card.classList.remove('disabled'); } catch (error) { console.error("處理檔案時發生錯誤:", error); alert("處理檔案時發生錯誤: " + error.message); step1Spinner.style.display = 'none'; startCleansingBtn.disabled = false; } }
        async function handleStep2() { if (!cleanedData) return alert('請先完成步驟1！'); generateOverallChartBtn.disabled = true; step2Spinner.style.display = 'block'; step2Output.style.display = 'block'; await new Promise(resolve => setTimeout(resolve, 500)); const averageScores = {}; DIMENSIONS.forEach(dim => { let totalScore = 0; let count = 0; const questionColumns = [...new Set(DIMENSION_MAPPING[dim])]; cleanedData.forEach(row => { questionColumns.forEach(col => { if (row.hasOwnProperty(col)) { const score = parseFloat(row[col]); if (!isNaN(score) && score > 0) { totalScore += score; count++; } } }); }); averageScores[dim] = count > 0 ? (totalScore / count) : 0; }); const scores = DIMENSIONS.map(dim => parseFloat(averageScores[dim].toFixed(2))); renderChart('overallBarChart', 'bar', DIMENSIONS, scores, '商業模式構面平均分數'); renderChart('overallRadarChart', 'radar', DIMENSIONS, scores, '商業模式構面平均分數'); let tableHTML = '<table class="table table-bordered"><thead><tr><th>構面</th><th>平均分數(不含0分)</th></tr></thead><tbody>'; DIMENSIONS.forEach(dim => { tableHTML += `<tr><td>${dim}</td><td>${averageScores[dim].toFixed(2)}</td></tr>`; }); tableHTML += '</tbody></table>'; document.getElementById('overallTableContainer').innerHTML = tableHTML; step2Spinner.style.display = 'none'; generateOverallChartBtn.disabled = false; }
        async function handleStep3() { if (!cleanedData) return alert('請先完成步驟1！'); exportCompanyAnalysisBtn.disabled = true; step3Spinner.style.display = 'block'; step3Output.style.display = 'none'; await new Promise(resolve => setTimeout(resolve, 1000)); try { const workbook = XLSX.utils.book_new(); const summaryData = []; const allGroupData = {}; const calculateGroupAverages = (groupRows) => { const groupScores = {}; DIMENSIONS.forEach(dim => { let totalScore = 0, count = 0; const questionColumns = [...new Set(DIMENSION_MAPPING[dim])]; groupRows.forEach(row => { questionColumns.forEach(col => { if (row.hasOwnProperty(col)) { const score = parseFloat(row[col]); if (!isNaN(score) && score > 0) { totalScore += score; count++; } } }); }); groupScores[dim] = count > 0 ? parseFloat((totalScore / count).toFixed(2)) : 0; }); return groupScores; }; const groupsMode1 = {}, groupsMode2 = {}; cleanedData.forEach(row => { const company = (row[PERSONAL_INFO_COLS[0]] || 'N/A').trim(); const email = (row[PERSONAL_INFO_COLS[2]] || 'N/A').trim(); if (!groupsMode1[company]) groupsMode1[company] = []; groupsMode1[company].push(row); const keyMode2 = `${company}||${email}`; if (!groupsMode2[keyMode2]) groupsMode2[keyMode2] = []; groupsMode2[keyMode2].push(row); }); for (const company in groupsMode1) { const avgScores = calculateGroupAverages(groupsMode1[company]); summaryData.push({ '分析模式': '模式1', '公司/群組': company, 'E-mail': '-', ...avgScores }); allGroupData[company] = avgScores; } for (const key in groupsMode2) { const [company, email] = key.split('||'); const avgScores = calculateGroupAverages(groupsMode2[key]); const groupName = `${company} (${email})`; summaryData.push({ '分析模式': '模式2', '公司/群組': company, 'E-mail': email, ...avgScores }); allGroupData[groupName] = avgScores; } const summarySheet = XLSX.utils.json_to_sheet(summaryData); XLSX.utils.book_append_sheet(workbook, summarySheet, '總表'); const sanitizeSheetName = (name) => name.substring(0, 31).replace(/[\\/*?[\]:]/g, "_"); for (const groupName in allGroupData) { const groupScores = allGroupData[groupName]; const sheetData = DIMENSIONS.map(dim => ({ '構面': dim, '平均分數': groupScores[dim] })); const individualSheet = XLSX.utils.json_to_sheet(sheetData); XLSX.utils.book_append_sheet(workbook, individualSheet, sanitizeSheetName(groupName)); } XLSX.writeFile(workbook, "公司分析報告.xlsx"); step3Output.style.display = 'block'; } catch (error) { console.error("生成Excel報告時發生錯誤:", error); alert("生成Excel報告時發生錯誤: " + error.message); } finally { exportCompanyAnalysisBtn.disabled = false; step3Spinner.style.display = 'none'; } }
        async function handleStep4() { if (!cleanedData) return alert('請先完成步驟1！'); generateIndividualChartsBtn.disabled = true; step4Spinner.style.display = 'block'; step4Output.innerHTML = ''; step4Output.style.display = 'block'; await new Promise(resolve => setTimeout(resolve, 200)); const groupedByCompany = {}; cleanedData.forEach(row => { const companyName = (row[PERSONAL_INFO_COLS[0]] || '（未指定公司）').trim(); if (!groupedByCompany[companyName]) { groupedByCompany[companyName] = []; } groupedByCompany[companyName].push(row); }); let globalChartIndex = 0; for (const companyName in groupedByCompany) { const companyContainer = document.createElement('div'); companyContainer.className = 'card mb-5'; companyContainer.innerHTML = `<div class="card-header bg-light"><h3 class="company-group-header mb-0">${companyName}</h3></div><div class="card-body"><div class="row"></div></div>`; step4Output.appendChild(companyContainer); const chartRow = companyContainer.querySelector('.row'); const companyRows = groupedByCompany[companyName]; companyRows.forEach(row => { const personName = row[PERSONAL_INFO_COLS[1]] || `(匿名)`; const scores = {}; DIMENSIONS.forEach(dim => { let totalScore = 0, count = 0; const questionColumns = [...new Set(DIMENSION_MAPPING[dim])]; questionColumns.forEach(col => { if (row.hasOwnProperty(col)) { const score = parseFloat(row[col]); if (!isNaN(score) && score > 0) { totalScore += score; count++; } } }); scores[dim] = count > 0 ? (totalScore / count) : 0; }); const scoreValues = DIMENSIONS.map(dim => parseFloat(scores[dim].toFixed(2))); const chartTitle = `${personName} 的商業模式構面平均分數`; const chartCardCol = document.createElement('div'); chartCardCol.className = 'col-lg-6 mb-4'; chartCardCol.innerHTML = `<div class="card h-100"><div class="card-header text-center">${chartTitle}</div><div class="card-body"><div class="row"><div class="col-12"><h6>長條圖</h6><div class="chart-container"><canvas id="individualBarChart-${globalChartIndex}"></canvas></div></div><div class="col-12 mt-3"><h6>雷達圖</h6><div class="chart-container"><canvas id="individualRadarChart-${globalChartIndex}"></canvas></div></div></div></div></div>`; chartRow.appendChild(chartCardCol); const currentChartIndex = globalChartIndex; setTimeout(() => { renderChart(`individualBarChart-${currentChartIndex}`, 'bar', DIMENSIONS, scoreValues, chartTitle); renderChart(`individualRadarChart-${currentChartIndex}`, 'radar', DIMENSIONS, scoreValues, chartTitle); }, 0); globalChartIndex++; }); } step4Spinner.style.display = 'none'; generateIndividualChartsBtn.disabled = false; }
        let charts = {}; function renderChart(canvasId, type, labels, data, title) { const ctx = document.getElementById(canvasId).getContext('2d'); if (charts[canvasId]) charts[canvasId].destroy(); Chart.defaults.font.family = "'微軟正黑體', 'Microsoft JhengHei', sans-serif"; const chartConfig = { type, data: { labels, datasets: [{ label: '分數', data, backgroundColor: type === 'radar' ? 'rgba(54, 162, 235, 0.2)' : 'rgba(54, 162, 235, 0.6)', borderColor: 'rgba(54, 162, 235, 1)', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: false }, legend: { display: false }, tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${c.raw}` } } }, scales: (type === 'bar') ? { y: { beginAtZero: true, suggestedMax: 5 } } : { r: { beginAtZero: true, suggestedMax: 5, pointLabels: { font: { size: 11 } } } }, animation: { onComplete: function() { if (type !== 'bar') return; const chart = this; const ctx = chart.ctx; ctx.font = Chart.helpers.toFont(Chart.defaults.font).string; ctx.textAlign = 'center'; ctx.textBaseline = 'bottom'; ctx.fillStyle = '#666'; this.data.datasets.forEach((d, i) => { const meta = chart.getDatasetMeta(i); meta.data.forEach((e, idx) => { const val = d.data[idx]; if (val >= 0) ctx.fillText(val, e.x, e.y - 5) }) }) } } } }; charts[canvasId] = new Chart(ctx, chartConfig); }
    </script>
</body>
</html>